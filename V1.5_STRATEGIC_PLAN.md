# V1.5 Strategic Plan: Expert Practitioner Alignment

## Executive Summary

V1.5 is a parallel, fast-follow project that addresses four critical blind spots in our V1 plan:
1. **Mobile-First Reality**: Native React Native app for "in-the-truck" usage
2. **Call Tracking**: Capture the #1 most valuable lead (phone calls)
3. **GBP Offense**: Proactive Google Business Profile management
4. **Voice-First Interface**: Reduce friction for non-desk users

**Timeline**: Parallel to V1, not blocking V1 launch
**Priority Order**: Call Tracking → GBP Offense → Mobile App → Voice-First
**Feature Gating**: Opt-in via "Growth" or "Pro" plans (Module 9)

---

## Development Priority Order

### Phase 1: Call Tracking (ROI Proof) - #1 Priority
**Goal**: Capture phone call leads and prove platform ROI

### Phase 2: GBP Offense (Competitive Advantage) - #2 Priority
**Goal**: Proactive Google Business Profile management for local ranking

### Phase 3: Mobile App (User Impact) - #3 Priority
**Goal**: Native mobile "cockpit" for daily operations

### Phase 4: Voice-First (UX Enhancement) - #4 Priority
**Goal**: Voice input across mobile app and key workflows

---

## Phase 1: Call Tracking Integration

### Task 1.5.1: Twilio Integration Setup
**Status**: New V1.5 Task
**Dependencies**: Module 9 (Billing) - Feature gating
**Modifies**: None (new service)

**Requirements**:
- Integrate Twilio SDK
- Create Twilio service wrapper (`libs/call-tracking/src/twilio_service.ts`)
- Environment variables: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER_POOL`
- Error handling and retry logic

**Deliverables**:
- Twilio service module
- Configuration management
- Unit tests

---

### Task 1.5.2: Call Tracking Database Schema
**Status**: New V1.5 Task
**Dependencies**: Module 7 (Contact Hub) - activity_events table
**Modifies**: Task 7.1 (Core Data Structures)

**Requirements**:
- Create `call_tracking_numbers` table:
  ```sql
  CREATE TABLE call_tracking_numbers (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    twilio_phone_number TEXT NOT NULL,
    twilio_phone_number_sid TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
  );
  ```
- Modify `activity_events` table to support `phone_call` event type
- Add JSONB `details` field to store: `direction`, `from`, `duration`, `status`

**Deliverables**:
- Database migration script
- Updated TypeScript types
- Schema documentation

---

### Task 1.5.3: Automated Phone Number Provisioning
**Status**: Modifies Task 1.1 (Onboarding Flow)
**Dependencies**: Task 1.5.1, Task 1.5.2
**Feature Flag**: `call_tracking_enabled` (Growth/Pro plans)

**Requirements**:
- During onboarding (Task 1.1), after business profile creation:
  1. Check user's plan (Module 9)
  2. If eligible (Growth/Pro), provision Twilio number
  3. Save to `call_tracking_numbers` table
  4. Display number in onboarding success screen
- Handle errors gracefully (don't block onboarding if provisioning fails)
- Log provisioning events

**Modifications to Task 1.1**:
- Add phone number provisioning step
- Update onboarding UI to show tracked number
- Add feature flag check

**Deliverables**:
- Updated onboarding flow
- Phone number provisioning service
- Error handling and logging

---

### Task 1.5.4: Website Integration (Tracked Number Display)
**Status**: Modifies Module 2 (Website Builder)
**Dependencies**: Task 1.5.3
**Feature Flag**: `call_tracking_enabled`

**Requirements**:
- Modify `generateInitialWebsite()` (Task 2.1) to:
  1. Check if user has tracked number
  2. If yes, use tracked number instead of real phone
  3. Display tracked number in contact sections, CTAs, footer
- Update website save/update logic to preserve tracked number
- Add tracked number badge/indicator in website editor

**Modifications to Task 2.1**:
- Phone number selection logic
- Website theme integration
- Editor UI updates

**Deliverables**:
- Updated website generator
- Editor UI components
- Integration tests

---

### Task 1.5.5: Call Webhook Handler
**Status**: New V1.5 Task
**Dependencies**: Task 1.5.2, Module 7 (Contact Hub)
**Feature Flag**: `call_tracking_enabled`

**Requirements**:
- Create `/api/call-tracking/webhook` endpoint
- Handle Twilio webhook events:
  - `call-initiated`: Log inbound call start
  - `call-completed`: Log call completion with duration/status
- Perform "get-or-create" contact logic:
  1. Search contacts by phone number
  2. If found, use existing contact
  3. If not found, create new contact with:
     - `name`: "Unknown Caller" (or attempt reverse lookup)
     - `phone`: Caller's number
     - `tags`: ['phone_lead', 'new_lead']
- Create `activity_events` record:
  - `event_type`: 'phone_call'
  - `content`: "Inbound call from (555) 123-4567"
  - `details`: JSONB with `direction`, `from`, `duration`, `status`

**Deliverables**:
- Webhook handler endpoint
- Contact matching logic
- Activity event creation
- Error handling and logging
- Integration tests

---

### Task 1.5.6: Call Tracking UI (Contact Hub)
**Status**: Modifies Task 7.3 (Unified Contact View)
**Dependencies**: Task 1.5.5
**Feature Flag**: `call_tracking_enabled`

**Requirements**:
- Display phone call events in contact activity timeline
- Show call metadata (duration, status, timestamp)
- Add "Call" button/link (if contact has phone number)
- Filter contacts by "phone_lead" tag
- Call history view (all calls, not just per-contact)

**Modifications to Task 7.3**:
- Activity timeline rendering
- Contact filters
- New "Calls" tab/view

**Deliverables**:
- Updated contact view UI
- Call history component
- Filtering logic

---

## Phase 2: Google Business Profile Offense

### Task 1.5.7: GBP OAuth Integration
**Status**: Modifies Module 8 (Reputation Hub) - OAuth flow
**Dependencies**: Task 8.2 (Connection Management)
**Feature Flag**: `gbp_offense_enabled` (Growth/Pro plans)

**Requirements**:
- Extend existing Google OAuth (Task 8.2) to include GBP API scopes:
  - `https://www.googleapis.com/auth/business.manage`
- Store GBP connection in `review_sources` table (reuse existing structure)
- Add GBP-specific fields:
  - `gbp_location_id`: The specific GBP location ID
  - `gbp_account_id`: The GBP account ID
- Update connection UI to show GBP connection status

**Modifications to Task 8.2**:
- OAuth scope expansion
- Token storage (reuse existing encryption)
- Connection management UI

**Deliverables**:
- Updated OAuth flow
- GBP connection storage
- UI updates

---

### Task 1.5.8: GBP API Service
**Status**: New V1.5 Task
**Dependencies**: Task 1.5.7
**Feature Flag**: `gbp_offense_enabled`

**Requirements**:
- Create GBP API service (`libs/reputation-hub/src/gbp_api.ts`)
- Functions:
  - `publishGBPPost(locationId, postContent)`: Publish standard post
  - `publishGBPReply(locationId, reviewId, replyContent)`: Publish review reply
  - `getGBPQuestions(locationId)`: Fetch unanswered questions
  - `publishGBPAnswer(locationId, questionId, answer)`: Publish Q&A answer
- Handle token refresh (reuse existing refresh logic from Module 8)
- Error handling and retry logic

**Deliverables**:
- GBP API service module
- Error handling
- Unit tests

---

### Task 1.5.9: Social Post to GBP (Task 5.3 Modification)
**Status**: Modifies Task 5.3 (Post Composer)
**Dependencies**: Task 1.5.8
**Feature Flag**: `gbp_offense_enabled`

**Requirements**:
- Add "Post to Google Business Profile" option in Post Composer
- When selected:
  1. Save post to `social_posts` table with `platform: 'google_business'`
  2. Set `status: 'draft'` (follows standard Module 5 workflow)
  3. User can approve/schedule like other social posts
- On publish (Task 5.5), if platform is `google_business`:
  1. Call `publishGBPPost()` from Task 1.5.8
  2. Update post status to `published`
  3. Store `platform_post_id` from GBP API response

**Modifications to Task 5.3**:
- Platform selection UI
- Post creation logic
- Publishing workflow

**Deliverables**:
- Updated Post Composer
- GBP publishing integration
- UI updates

---

### Task 1.5.10: Weekly GBP Updates (Task 3.3 Modification)
**Status**: Modifies Task 3.3 (Content Generator)
**Dependencies**: Task 1.5.8
**Feature Flag**: `gbp_offense_enabled`

**Requirements**:
- Add new content type: "Weekly GBP Update"
- AI generates short, engaging posts (150-300 characters)
- Topics: Recent work, promotions, tips, community involvement
- Save to `social_posts` table:
  - `platform: 'google_business'`
  - `status: 'draft'`
  - `metadata.type: 'weekly_update'`
- Create scheduled job (cron) to generate weekly:
  - Runs every Monday
  - Generates 3-5 draft posts
  - User approves/schedules in content calendar

**Modifications to Task 3.3**:
- New content generation prompt
- Post creation logic
- Scheduled job

**Deliverables**:
- GBP update generator
- Scheduled job
- Content calendar integration

---

### Task 1.5.11: Direct GBP Reply Publishing (Task 8.8 Modification)
**Status**: Modifies Task 8.8 (Response Publisher)
**Dependencies**: Task 1.5.8
**Feature Flag**: `gbp_offense_enabled`

**Requirements**:
- Modify `runResponsePublisher()` job:
  1. Find reviews with `status: 'response_approved'` AND `platform: 'google'`
  2. For each approved Google review:
     - Call `publishGBPReply()` from Task 1.5.8
     - If successful: Update `status: 'response_sent'`
     - If failed: Update `status: 'response_failed'`, log error
  3. Keep existing queue logic for other platforms (Yelp, Facebook)
- Update `review_responses` table with `platform_response_id` from GBP API

**Modifications to Task 8.8**:
- Publishing logic (Google-specific)
- Error handling
- Status updates

**Deliverables**:
- Updated response publisher
- GBP reply publishing
- Error logging

---

### Task 1.5.12: GBP Q&A Management
**Status**: New V1.5 Task
**Dependencies**: Task 1.5.8, Task 8.4 (Unified Review Inbox)
**Feature Flag**: `gbp_offense_enabled`

**Requirements**:
- Create new table `gbp_questions`:
  ```sql
  CREATE TABLE gbp_questions (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    source_id UUID REFERENCES review_sources(id),
    question_id TEXT NOT NULL, -- GBP API question ID
    question_text TEXT NOT NULL,
    asked_by TEXT, -- Customer name if available
    suggested_answer TEXT, -- AI-generated answer
    status TEXT CHECK (status IN ('pending', 'approved', 'published', 'dismissed')),
    approved_answer TEXT, -- User's final answer
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
  );
  ```
- Scheduled job to fetch unanswered questions (daily):
  1. Call `getGBPQuestions()` for each connected GBP
  2. For each question, generate AI answer (Task 3.3)
  3. Save to `gbp_questions` with `status: 'pending'`
- Display in Unified Review Inbox (Task 8.4) as new item type:
  - Show question and suggested answer
  - User can approve/edit/publish
- On publish, call `publishGBPAnswer()` from Task 1.5.8

**Deliverables**:
- Database schema
- Q&A fetching job
- AI answer generation
- Inbox UI integration
- Publishing logic

---

## Phase 3: Native Mobile App

### Task 1.5.13: React Native Project Setup
**Status**: New V1.5 Task
**Dependencies**: None (new project)
**Feature Flag**: N/A (app is V1.5-only)

**Requirements**:
- Create `apps/mobile-app` directory
- Initialize React Native project (Expo or bare React Native)
- Set up monorepo structure (Turborepo)
- Configure shared `libs/` and `types/` imports
- Set up Supabase Auth (JWT) integration
- Configure environment variables

**Deliverables**:
- React Native project structure
- Monorepo configuration
- Auth setup
- Development environment

---

### Task 1.5.14: Mobile App Authentication
**Status**: New V1.5 Task
**Dependencies**: Task 1.5.13, Module 1 (Auth)
**Feature Flag**: N/A

**Requirements**:
- Implement Supabase Auth login/signup
- JWT token management
- Session persistence
- Logout functionality
- Error handling

**Deliverables**:
- Auth screens
- Token management
- Session handling

---

### Task 1.5.15: Push Notifications Setup
**Status**: New V1.5 Task
**Dependencies**: Task 1.5.13
**Feature Flag**: N/A

**Requirements**:
- Integrate Firebase Cloud Messaging (FCM) or Expo Push Notifications
- Device token registration endpoint: `/api/mobile/register-device`
- Store device tokens in new table `device_tokens`:
  ```sql
  CREATE TABLE device_tokens (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    device_token TEXT NOT NULL,
    platform TEXT CHECK (platform IN ('ios', 'android')),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, device_token)
  );
  ```
- Backend notification service (`libs/notifications/src/push_service.ts`)
- Trigger notifications for:
  - New inbox messages (Task 5.7)
  - New reviews (Task 8.4)
  - New phone calls (Task 1.5.5)

**Deliverables**:
- Push notification setup
- Device token management
- Notification service
- Backend triggers

---

### Task 1.5.16: Unified Inbox Tab (Mobile)
**Status**: New V1.5 Task
**Dependencies**: Task 5.7 (Unified Inbox), Task 1.5.15
**Feature Flag**: N/A

**Requirements**:
- Native UI for Unified Inbox
- Display conversations from:
  - Social messages (Module 5)
  - Email replies (Module 6)
  - Review notifications (Module 8)
- Real-time updates (Supabase Realtime or polling)
- Push notifications for new messages
- Tap to open conversation detail
- Mark as read/unread
- Reply functionality (text input)

**API Reuse**:
- `GET /api/social/conversations` (Task 5.7)
- `GET /api/social/conversations/[id]/messages` (Task 5.7)
- `POST /api/social/conversations/[id]/reply` (Task 5.7)

**Deliverables**:
- Inbox list screen
- Conversation detail screen
- Reply UI
- Real-time updates
- Push notifications

---

### Task 1.5.17: Contact Hub Tab (Mobile)
**Status**: New V1.5 Task
**Dependencies**: Task 7.3 (Unified Contact View), Task 1.5.5
**Feature Flag**: N/A

**Requirements**:
- Read-only contact list (searchable, filterable)
- Contact detail view:
  - Contact info
  - Activity timeline (calls, messages, events)
  - Tags
- Tap phone number to call (native dialer)
- Tap email to open email client
- Filter by tags (e.g., "phone_lead")

**API Reuse**:
- `GET /api/contacts` (Task 7.1)
- `GET /api/contacts/[id]` (Task 7.1)

**Deliverables**:
- Contact list screen
- Contact detail screen
- Search/filter UI
- Native integrations (phone, email)

---

### Task 1.5.18: AI Chat Tab (Mobile)
**Status**: New V1.5 Task
**Dependencies**: Task 1.1 (Chat Orchestrator)
**Feature Flag**: N/A

**Requirements**:
- Native chat interface
- Message history
- Real-time message streaming
- Voice input button (Phase 4)
- Send message functionality

**API Reuse**:
- `POST /api/chat/send` (Task 1.1)
- `GET /api/chat/messages` (Task 1.1)

**Deliverables**:
- Chat screen
- Message list
- Input UI
- Real-time updates

---

## Phase 4: Voice-First Interface

### Task 1.5.19: OpenAI Whisper Integration
**Status**: New V1.5 Task
**Dependencies**: None (new service)
**Feature Flag**: `voice_input_enabled` (Growth/Pro plans)

**Requirements**:
- Create Whisper service (`libs/voice/src/whisper_service.ts`)
- Function: `transcribeAudio(audioFile: Buffer): Promise<string>`
- Handle audio file formats (MP3, WAV, M4A)
- Error handling and retry logic
- Rate limiting

**Deliverables**:
- Whisper service module
- Audio processing
- Error handling
- Unit tests

---

### Task 1.5.20: Voice Input in Onboarding (Task 1.1 Modification)
**Status**: Modifies Task 1.1 (Onboarding Flow)
**Dependencies**: Task 1.5.19
**Feature Flag**: `voice_input_enabled`

**Requirements**:
- Add "Type or Speak" toggle to onboarding form fields:
  - Business description
  - Services list
  - Target audience
- Voice input UI:
  - Record button
  - Stop button
  - Audio waveform visualization
- On stop, upload audio to backend
- Backend transcribes using Whisper
- Display transcription in text field (editable)
- User can edit before submitting

**Modifications to Task 1.1**:
- Form UI updates
- Voice recording component
- Transcription integration

**Deliverables**:
- Voice input UI
- Recording component
- Transcription flow
- Error handling

---

### Task 1.5.21: Voice Note in Review Workflow (Task 8.7 Modification)
**Status**: Modifies Task 8.7 (Reply-to-Edit Handler)
**Dependencies**: Task 1.5.19, Task 1.5.16 (Mobile App)
**Feature Flag**: `voice_input_enabled`

**Requirements**:
- Mobile app only (not web)
- In review approval screen (Task 8.6), add "Request Changes" button
- On tap, show voice recording UI
- Record audio, upload to backend
- Backend transcribes using Whisper
- Auto-apply transcription as feedback to `reviseDraftAndAssets()` (Task 8.7)
- Send notification to content team (if applicable)

**Modifications to Task 8.7**:
- Accept audio file input
- Transcription logic
- Feedback application

**Deliverables**:
- Mobile voice recording UI
- Backend transcription endpoint
- Feedback application logic

---

### Task 1.5.22: Voice Social Post Composer (Task 5.3 Modification)
**Status**: Modifies Task 5.3 (Post Composer)
**Dependencies**: Task 1.5.19, Task 1.5.16 (Mobile App)
**Feature Flag**: `voice_input_enabled`

**Requirements**:
- Mobile app only (not web)
- Add "Record Post" button in Post Composer
- User speaks post content (e.g., "Just finished a new water heater install on Main St.")
- Upload audio, transcribe with Whisper
- AI enhances/professionalizes the transcription:
  - Add proper grammar
  - Add relevant hashtags
  - Optimize for platform (LinkedIn vs Instagram)
  - Add call-to-action if appropriate
- Display enhanced version for user approval/edit
- User can edit before publishing

**Modifications to Task 5.3**:
- Voice recording UI
- Transcription integration
- AI enhancement logic

**Deliverables**:
- Voice recording component
- Transcription service
- AI enhancement service

---

## Database Schema Updates

### New Tables

1. **call_tracking_numbers**
   - Stores Twilio phone numbers per user
   - Links to user account

2. **device_tokens**
   - Stores FCM/Expo push notification tokens
   - Links to user account

3. **gbp_questions**
   - Stores Google Business Profile Q&A
   - Tracks AI suggestions and user approvals

### Modified Tables

1. **activity_events**
   - Add `phone_call` event type
   - Enhance `details` JSONB for call metadata

2. **review_sources**
   - Add GBP-specific fields (`gbp_location_id`, `gbp_account_id`)
   - Extend OAuth scopes

3. **social_posts**
   - Add `platform: 'google_business'` support
   - Add `metadata.type: 'weekly_update'` support

---

## API Endpoints

### New Endpoints

1. `POST /api/call-tracking/webhook` - Twilio webhook handler
2. `POST /api/mobile/register-device` - Device token registration
3. `POST /api/voice/transcribe` - Audio transcription
4. `GET /api/gbp/questions` - Fetch GBP questions
5. `POST /api/gbp/questions/[id]/answer` - Publish Q&A answer

### Modified Endpoints

1. `POST /api/website/generate` - Include tracked number
2. `POST /api/social/posts` - Support GBP platform
3. `POST /api/reputation/approve` - Trigger direct GBP publishing
4. `POST /api/content/generate` - Support GBP update generation

---

## Feature Flags (Module 10)

New flags to add:
- `call_tracking_enabled` - Unlocks call tracking features
- `gbp_offense_enabled` - Unlocks GBP publishing features
- `voice_input_enabled` - Unlocks voice input features

Flag mapping to plans:
- **Starter Plan**: All flags disabled
- **Growth Plan**: All flags enabled
- **Pro Plan**: All flags enabled

---

## Testing Strategy

### New Test Suites

1. `tests/call-tracking/` - Call tracking webhook and provisioning
2. `tests/gbp-api/` - GBP API integration
3. `tests/mobile-app/` - Mobile app components
4. `tests/voice/` - Voice transcription and processing

### Modified Test Suites

1. `tests/module-1/` - Add voice input tests
2. `tests/module-2/` - Add tracked number display tests
3. `tests/module-5/` - Add GBP posting tests
4. `tests/module-7/` - Add phone call event tests
5. `tests/module-8/` - Add direct GBP publishing tests

---

## Implementation Checklist

### Phase 1: Call Tracking
- [ ] Task 1.5.1: Twilio Integration Setup
- [ ] Task 1.5.2: Call Tracking Database Schema
- [ ] Task 1.5.3: Automated Phone Number Provisioning
- [ ] Task 1.5.4: Website Integration (Tracked Number Display)
- [ ] Task 1.5.5: Call Webhook Handler
- [ ] Task 1.5.6: Call Tracking UI (Contact Hub)

### Phase 2: GBP Offense
- [ ] Task 1.5.7: GBP OAuth Integration
- [ ] Task 1.5.8: GBP API Service
- [ ] Task 1.5.9: Social Post to GBP (Task 5.3 Modification)
- [ ] Task 1.5.10: Weekly GBP Updates (Task 3.3 Modification)
- [ ] Task 1.5.11: Direct GBP Reply Publishing (Task 8.8 Modification)
- [ ] Task 1.5.12: GBP Q&A Management

### Phase 3: Mobile App
- [ ] Task 1.5.13: React Native Project Setup
- [ ] Task 1.5.14: Mobile App Authentication
- [ ] Task 1.5.15: Push Notifications Setup
- [ ] Task 1.5.16: Unified Inbox Tab (Mobile)
- [ ] Task 1.5.17: Contact Hub Tab (Mobile)
- [ ] Task 1.5.18: AI Chat Tab (Mobile)

### Phase 4: Voice-First
- [ ] Task 1.5.19: OpenAI Whisper Integration
- [ ] Task 1.5.20: Voice Input in Onboarding (Task 1.1 Modification)
- [ ] Task 1.5.21: Voice Note in Review Workflow (Task 8.7 Modification)
- [ ] Task 1.5.22: Voice Social Post Composer (Task 5.3 Modification)

---

## Risk Mitigation

1. **Twilio Costs**: Monitor phone number and call costs per user
2. **GBP API Rate Limits**: Implement rate limiting and retry logic
3. **Mobile App Complexity**: Start with MVP (3 tabs only)
4. **Voice Transcription Accuracy**: Provide edit capability after transcription
5. **Feature Flag Rollout**: Gradual rollout to Growth/Pro plans

---

## Success Metrics

1. **Call Tracking**: % of users with tracked numbers, call-to-lead conversion rate
2. **GBP Offense**: GBP post frequency, reply response time, Q&A answer rate
3. **Mobile App**: Daily active users, push notification open rate
4. **Voice-First**: Voice input usage rate, transcription accuracy

---

**Status**: ✅ Plan Confirmed - Ready for Implementation
**Next Step**: Begin Phase 1 (Call Tracking) development

